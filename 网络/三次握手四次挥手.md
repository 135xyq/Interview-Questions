# 三次握手四次挥手

tcp连接创建的前提是要保证通信双方能自由的发送和接受消息。

SYN: 初始化一个序列号，用于建立连接

FIN：用于断开连接

ACK: 表示确认

## 三次握手过程

- 第一次握手

   客户端向服务器发送一个SYN包，自身进入SYN_WAIT状态，等待服务器响应。包中还包含一个seq序列号。本次握手的意义是客户端希望与服务器建立连接。

- 第二次握手

   服务器收到SYN包后，返回一个SYN+ACK包给客户端，自身进入SYN_RCVD状态。本次握手的意义是服务器收到并同意客户端建立连接的请求

- 第三次握手

   客户端收到SYN包后再次向服务器发送一个ACK包，然后自身进入ESTABLISHED状态。然后服务器收到ACK包，也进入ESTABLISHED状态。至此，连接建立完成。

## 四次挥手过程

客户端是主动关闭: FIN_WAIT1 ---> FIN_WAIT2 ---->  TIME_OUT--->CLOSED

服务器是被动关闭:  CLOSED_WAIT ---> LAST_ACK ---> CLOSED

- 客户端向服务器发送FIN包，表明客户端要主动断开连接，自身进入FIN_WAIT1状态。
- 服务器接受到FIN包后，返回ACK包给客户端表明自已经收到客户端要断开连接，但是自己还没有准备好。此时服务器进入CLOSED_WAIT状态。客户端接受到ACK包后进入FIN_WAIT2状态。
- 服务器发送完剩余数据后，会发送FIN包给客户端。此时服务器进入LAST_ACK状态，等待客户端返回ACK包。
- 客户端接受到FIN包后，返回ACK包给服务器。同时客户端进入TIME_WAIT状态，等待2MSL时间以保证服务器能接受到ACK包后进入CLOSED状态。服务器收到ACK包立即进入CLOSED状态。

## 为什么最后要等待2MSL？

因为客户端要确保服务器能接受到最后一次的ACK包。如果说最后一次客户端发送的ACK包在传输过程中出现了数据丢失的情况，服务器会以为是自己发送的FIN包没有成功到达客户端，于是会重新发送FIN包给客户端，在这2MSL时间内，客户端能重新接受FIN包并且重新给服务器返回ACK包。

## 为什么不能进行一次/两次握手？

为了防止已失效的连接请求报文段突然重新发送到服务端，导致建立不必要的连接

## 为什么要进行三次握手？

因为至少得三次握手才能保证通信双方都能正常的接受和发送消息，超过三次以上后，多余的握手没有太大意义。



